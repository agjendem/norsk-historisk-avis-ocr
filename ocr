#!/usr/bin/env bash
set -euo pipefail

PROJECT_DIR="$(cd "$(dirname "$0")" && pwd)"
INPUT_DIR="$PROJECT_DIR/input"

SUPPORTED_EXTENSIONS="pdf png jpg jpeg tiff tif"

usage() {
    cat <<EOF
Usage: ./ocr [engine] [engine-options]

Engines:
  tesseract       Tesseract OCR (local, offline)
  claude-vision   Claude Vision API (requires API key)

The CLI presents an interactive file picker to select files from input/.
Processed files are marked with [done].

Examples:
  ./ocr                                    # pick engine, then pick files
  ./ocr tesseract                          # pick files for tesseract
  ./ocr claude-vision --dpi 400            # pick files for claude-vision

Setup:
  ./tesseract/setup.sh                     # Install Tesseract dependencies
  ./claude-vision/setup.sh                 # Install Claude Vision dependencies
EOF
}

ensure_api_key() {
    # Already in environment
    if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
        return
    fi

    # Try loading from .env
    if [[ -f "$PROJECT_DIR/.env" ]]; then
        # shellcheck disable=SC1091
        source "$PROJECT_DIR/.env"
        if [[ -n "${ANTHROPIC_API_KEY:-}" ]]; then
            export ANTHROPIC_API_KEY
            return
        fi
    fi

    # Prompt interactively
    echo "No ANTHROPIC_API_KEY found in environment or .env file."
    printf "Enter your Anthropic API key: "
    read -r key
    if [[ -z "$key" ]]; then
        echo "Error: API key is required for claude-vision." >&2
        exit 1
    fi
    echo "ANTHROPIC_API_KEY=$key" > "$PROJECT_DIR/.env"
    export ANTHROPIC_API_KEY="$key"
    echo "Saved to .env"
}

# Determine output suffix based on engine
output_suffix() {
    case "$ENGINE" in
        tesseract)      echo ".txt" ;;
        claude-vision)  echo ".vision.txt" ;;
    esac
}

# Collect supported files from input/ into FILES array.
# Returns 1 if no files found.
list_files() {
    FILES=()
    for ext in $SUPPORTED_EXTENSIONS; do
        for f in "$INPUT_DIR"/*."$ext"; do
            [[ -e "$f" ]] && FILES+=("$f")
        done
    done

    if [[ ${#FILES[@]} -eq 0 ]]; then
        echo "No supported files found in $INPUT_DIR/"
        return 1
    fi

    local suffix
    suffix="$(output_suffix)"

    echo ""
    echo "Files in input/:"
    local i=1
    for f in "${FILES[@]}"; do
        local basename
        basename="$(basename "$f")"
        local stem="${basename%.*}"
        local marker=""
        if [[ -f "$PROJECT_DIR/output/${stem}${suffix}" ]]; then
            marker=" [done]"
        fi
        printf "  %d) %s%s\n" "$i" "$basename" "$marker"
        ((i++))
    done
    echo "  q) Quit"
    echo ""
}

# Run the engine on a single file, passing through extra engine args.
run_engine() {
    local file="$1"
    shift
    case "$ENGINE" in
        tesseract)
            "$PROJECT_DIR/tesseract/ocr.sh" "$file" || true
            ;;
        claude-vision)
            "$PROJECT_DIR/claude-vision/ocr.py" "$file" "$@" || true
            ;;
    esac
}

# --- Main ---

if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    usage
    exit 0
fi

if [[ $# -eq 0 ]]; then
    echo "Select an OCR engine:"
    echo "  1) tesseract"
    echo "  2) claude-vision"
    printf "Choice [1-2]: "
    read -r choice
    case "$choice" in
        1) ENGINE="tesseract" ;;
        2) ENGINE="claude-vision" ;;
        *)
            echo "Error: Invalid choice '$choice'" >&2
            exit 1
            ;;
    esac
else
    ENGINE="$1"
    shift
fi

# Engine-specific setup
ENGINE_ARGS=("$@")

case "$ENGINE" in
    tesseract)
        if ! command -v tesseract &>/dev/null || ! command -v pdftoppm &>/dev/null; then
            echo "Missing dependencies for tesseract engine."
            printf "Run tesseract/setup.sh now? [Y/n] "
            read -r answer
            if [[ "${answer,,}" =~ ^(y|)$ ]]; then
                "$PROJECT_DIR/tesseract/setup.sh"
            else
                exit 1
            fi
        fi
        ;;
    claude-vision)
        if ! command -v pdftoppm &>/dev/null || [[ ! -f "$PROJECT_DIR/.venv/bin/python" ]]; then
            echo "Missing dependencies for claude-vision engine."
            printf "Run claude-vision/setup.sh now? [Y/n] "
            read -r answer
            if [[ "${answer,,}" =~ ^(y|)$ ]]; then
                "$PROJECT_DIR/claude-vision/setup.sh"
            else
                exit 1
            fi
        fi
        ensure_api_key
        # Activate venv if it exists
        if [[ -f "$PROJECT_DIR/.venv/bin/activate" ]]; then
            # shellcheck disable=SC1091
            source "$PROJECT_DIR/.venv/bin/activate"
        fi
        ;;
    *)
        echo "Error: Unknown engine '$ENGINE'" >&2
        echo "" >&2
        usage >&2
        exit 1
        ;;
esac

# Interactive file picker loop
while true; do
    if ! list_files; then
        exit 0
    fi

    printf "Select file [1-%d or q]: " "${#FILES[@]}"
    read -r selection

    if [[ "$selection" == "q" ]] || [[ "$selection" == "Q" ]]; then
        echo "Bye."
        exit 0
    fi

    # Validate numeric input
    if ! [[ "$selection" =~ ^[0-9]+$ ]] || [[ "$selection" -lt 1 ]] || [[ "$selection" -gt ${#FILES[@]} ]]; then
        echo "Invalid selection '$selection'"
        continue
    fi

    local_file="${FILES[$((selection - 1))]}"
    echo ""
    run_engine "$local_file" "${ENGINE_ARGS[@]}"
done
